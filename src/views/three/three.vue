<template>
  <div class="relative w-screen h-screen overflow-hidden ">
    <!-- 加载提示 -->
    <div v-if="loading"
      class="absolute inset-0 bg-black bg-opacity-80 flex flex-col justify-center items-center text-white z-[100]">
      <div class="w-12 h-12 border-3 border-gray-300 border-t-blue-500 rounded-full animate-spin mb-5"></div>
      <p>加载中... {{ loadingProgress }}%</p>
    </div>

    <!-- 错误提示 -->
    <div v-if="error"
      class="absolute inset-0 bg-black bg-opacity-80 flex flex-col justify-center items-center text-white z-[100]">
      <p>{{ error }}</p>
      <button @click="retryLoad"
        class="mt-5 px-5 py-2.5 bg-blue-500 text-white border-none rounded cursor-pointer hover:bg-blue-600">重试</button>
    </div>

    <!-- Three.js 渲染容器 -->
    <div ref="containerRef" class="w-full h-[45%] relative" style="background: transparent;"></div>



    <!-- 高级设置面板 -->
    <div v-show="showControlPanel"
      class="fixed top-16 right-5 bg-white bg-opacity-95 backdrop-blur-sm rounded-lg p-4 shadow-lg max-w-xs z-10 transition-all duration-300 max-h-[70vh] overflow-y-auto">
      <!-- 相机位置控制 -->
      <div class="mb-4">
        <label class="block mb-2 font-semibold text-gray-700 text-sm">相机位置:</label>
        <div class="space-y-2">
          <div>
            <label class="block text-xs text-gray-600 mb-1">X轴: {{ cameraPosition.x.toFixed(1) }}</label>
            <input type="range" v-model.number="cameraPosition.x" min="-20" max="20" step="0.1"
              @input="updateCameraPosition"
              class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
          </div>
          <div>
            <label class="block text-xs text-gray-600 mb-1">Y轴: {{ cameraPosition.y.toFixed(1) }}</label>
            <input type="range" v-model.number="cameraPosition.y" min="-20" max="20" step="0.1"
              @input="updateCameraPosition"
              class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
          </div>
          <div>
            <label class="block text-xs text-gray-600 mb-1">Z轴: {{ cameraPosition.z.toFixed(1) }}</label>
            <input type="range" v-model.number="cameraPosition.z" min="2" max="10" step="0.1"
              @input="updateCameraPosition"
              class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
          </div>
        </div>
      </div>

      <!-- 灯光控制 -->
      <div class="mb-4">
        <label class="block mb-2 font-semibold text-gray-700 text-sm">灯光强度:</label>
        <div class="space-y-2">
          <div>
            <label class="block text-xs text-gray-600 mb-1">环境光: {{ lightingIntensity.ambient.toFixed(1) }}</label>
            <input type="range" v-model.number="lightingIntensity.ambient" min="0" max="3" step="0.1"
              @input="updateLightingIntensity"
              class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
          </div>
          <div>
            <label class="block text-xs text-gray-600 mb-1">主光源: {{ lightingIntensity.directional.toFixed(1) }}</label>
            <input type="range" v-model.number="lightingIntensity.directional" min="0" max="3" step="0.1"
              @input="updateLightingIntensity"
              class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
          </div>
        </div>
      </div>

      <!-- 其他控制 -->
      <div class="space-y-2">
        <button @click="toggleAnimation"
          :class="['w-full px-3 py-2 text-xs rounded border', isAnimating ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-700 border-gray-300']">
          {{ isAnimating ? '暂停旋转' : '开始旋转' }}
        </button>
        <button @click="resetView"
          class="w-full px-3 py-2 text-xs rounded border bg-white text-gray-700 border-gray-300">重置视角</button>
        <button @click="takeScreenshot"
          class="w-full px-3 py-2 text-xs rounded border bg-white text-gray-700 border-gray-300">截图</button>
      </div>
    </div>

    <!-- 主要控制面板 -->
    <div class="">

      <div class="flex justify-center items-center">

        <svg width="192" height="72" viewBox="0 0 192 72" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M93.2422 58.6328L96.1905 61.6245L93.2422 64.6162" stroke="white" stroke-linecap="round"
            stroke-linejoin="round" />
          <path
            d="M102.087 61.0001C107.294 59.846 110.932 57.2102 110.932 54.1433C110.932 50.0126 104.332 46.6641 96.1908 46.6641C88.0493 46.6641 81.4492 50.0126 81.4492 54.1433C81.4492 58.2739 88.0493 61.6225 96.1908 61.6225"
            stroke="white" stroke-linecap="round" stroke-linejoin="round" />
          <path
            d="M25.0517 20.2593C25.5837 20.1006 26.2371 19.9 27.0117 19.6573C27.7864 19.4146 28.5704 19.1626 29.3637 18.9013L29.4897 19.7693C28.7617 20.012 28.0291 20.2593 27.2917 20.5113C26.5637 20.754 25.9011 20.9733 25.3037 21.1693L25.0517 20.2593ZM25.1637 15.5553H29.4057V16.4373H25.1637V15.5553ZM26.9977 12.7133H27.9217V24.3473C27.9217 24.618 27.8844 24.828 27.8097 24.9773C27.7351 25.1266 27.6137 25.2386 27.4457 25.3133C27.2871 25.3973 27.0677 25.4486 26.7877 25.4673C26.5077 25.4953 26.1437 25.5046 25.6957 25.4953C25.6864 25.374 25.6537 25.2246 25.5977 25.0473C25.5417 24.8793 25.4811 24.73 25.4157 24.5993C25.7237 24.6086 26.0037 24.6133 26.2557 24.6133C26.5077 24.6133 26.6757 24.6086 26.7597 24.5993C26.8531 24.5993 26.9137 24.5806 26.9417 24.5433C26.9791 24.506 26.9977 24.4406 26.9977 24.3473V12.7133ZM31.2117 14.7013H37.9317V15.5553H31.2117V14.7013ZM33.6197 16.0173H34.4597V23.1993H33.6197V16.0173ZM31.5897 12.6993L32.4997 12.9093C32.3037 13.5533 32.0704 14.1833 31.7997 14.7993C31.5384 15.406 31.2491 15.9706 30.9317 16.4933C30.6144 17.016 30.2737 17.478 29.9097 17.8793C29.8631 17.8326 29.7884 17.772 29.6857 17.6973C29.5924 17.6226 29.4991 17.5526 29.4057 17.4873C29.3124 17.422 29.2284 17.3706 29.1537 17.3333C29.6951 16.764 30.1757 16.0733 30.5957 15.2613C31.0157 14.4493 31.3471 13.5953 31.5897 12.6993ZM29.5037 20.1613L36.4477 17.4453L36.7277 18.2293L29.7837 20.9453L29.5037 20.1613ZM30.9597 17.1653H31.8137V23.8853C31.8137 24.0813 31.8417 24.2306 31.8977 24.3333C31.9537 24.436 32.0564 24.506 32.2057 24.5433C32.3644 24.5806 32.5977 24.5993 32.9057 24.5993C32.9897 24.5993 33.1391 24.5993 33.3537 24.5993C33.5777 24.5993 33.8297 24.5993 34.1097 24.5993C34.3991 24.5993 34.6884 24.5993 34.9777 24.5993C35.2671 24.5993 35.5284 24.5993 35.7617 24.5993C36.0044 24.5993 36.1817 24.5993 36.2937 24.5993C36.5457 24.5993 36.7324 24.5573 36.8537 24.4733C36.9751 24.3986 37.0591 24.2493 37.1057 24.0253C37.1617 23.792 37.1991 23.4513 37.2177 23.0033C37.3297 23.0686 37.4651 23.134 37.6237 23.1993C37.7824 23.2553 37.9224 23.2973 38.0437 23.3253C38.0064 23.8666 37.9317 24.2913 37.8197 24.5993C37.7171 24.9073 37.5491 25.122 37.3157 25.2433C37.0917 25.3646 36.7651 25.4253 36.3357 25.4253C36.2611 25.4253 36.1071 25.4253 35.8737 25.4253C35.6404 25.4253 35.3697 25.4253 35.0617 25.4253C34.7537 25.4253 34.4457 25.4253 34.1377 25.4253C33.8297 25.4253 33.5591 25.4253 33.3257 25.4253C33.0924 25.4253 32.9431 25.4253 32.8777 25.4253C32.3831 25.4253 31.9957 25.3833 31.7157 25.2993C31.4357 25.2153 31.2397 25.0613 31.1277 24.8373C31.0157 24.6133 30.9597 24.296 30.9597 23.8853V17.1653ZM36.2657 17.6413H36.1397L36.3777 17.4313L36.5457 17.3053L37.1477 17.5573L37.1057 17.6973C37.1057 18.1826 37.1011 18.654 37.0917 19.1113C37.0917 19.5593 37.0871 19.9746 37.0777 20.3573C37.0777 20.7306 37.0731 21.048 37.0637 21.3093C37.0544 21.5706 37.0404 21.748 37.0217 21.8413C37.0031 22.084 36.9377 22.2706 36.8257 22.4013C36.7137 22.5226 36.5597 22.602 36.3637 22.6393C36.2144 22.686 36.0324 22.714 35.8177 22.7233C35.6124 22.7326 35.4304 22.7326 35.2717 22.7233C35.2624 22.5926 35.2391 22.448 35.2017 22.2893C35.1644 22.1306 35.1131 22 35.0477 21.8973C35.1971 21.9066 35.3557 21.9113 35.5237 21.9113C35.6917 21.9113 35.8131 21.9113 35.8877 21.9113C35.9717 21.9113 36.0371 21.8973 36.0837 21.8693C36.1397 21.832 36.1771 21.7573 36.1957 21.6453C36.2237 21.552 36.2424 21.3233 36.2517 20.9593C36.2611 20.586 36.2657 20.1146 36.2657 19.5453C36.2657 18.9666 36.2657 18.332 36.2657 17.6413ZM45.7437 15.9753H51.3857V16.8713H45.7437V15.9753ZM50.9377 15.9753H51.8477C51.8477 15.9753 51.8477 16.008 51.8477 16.0733C51.8477 16.1293 51.8431 16.1993 51.8337 16.2833C51.8337 16.358 51.8337 16.4186 51.8337 16.4653C51.7871 17.912 51.7404 19.1346 51.6937 20.1333C51.6471 21.132 51.5911 21.9533 51.5257 22.5973C51.4604 23.232 51.3857 23.7266 51.3017 24.0813C51.2177 24.436 51.1104 24.688 50.9797 24.8373C50.8491 25.0053 50.7091 25.122 50.5597 25.1873C50.4104 25.262 50.2237 25.3133 49.9997 25.3413C49.7851 25.36 49.4957 25.3646 49.1317 25.3553C48.7771 25.3553 48.4131 25.3413 48.0397 25.3133C48.0304 25.1733 47.9977 25.0146 47.9417 24.8373C47.8951 24.6693 47.8297 24.52 47.7457 24.3893C48.1564 24.4266 48.5344 24.4453 48.8797 24.4453C49.2251 24.4546 49.4724 24.4593 49.6217 24.4593C49.7431 24.4686 49.8457 24.4593 49.9297 24.4313C50.0231 24.4033 50.1024 24.352 50.1677 24.2773C50.2704 24.156 50.3591 23.932 50.4337 23.6053C50.5084 23.2693 50.5737 22.7886 50.6297 22.1633C50.6857 21.538 50.7371 20.74 50.7837 19.7693C50.8397 18.7893 50.8911 17.5946 50.9377 16.1853V15.9753ZM47.8577 12.9513H48.7817C48.7817 13.9033 48.7677 14.8646 48.7397 15.8353C48.7117 16.7966 48.6464 17.7393 48.5437 18.6633C48.4504 19.5873 48.3011 20.474 48.0957 21.3233C47.8904 22.1633 47.6011 22.938 47.2277 23.6473C46.8637 24.3566 46.3971 24.982 45.8277 25.5233C45.7717 25.4486 45.7017 25.3693 45.6177 25.2853C45.5337 25.2013 45.4451 25.1173 45.3517 25.0333C45.2584 24.9586 45.1697 24.9026 45.0857 24.8653C45.6364 24.3706 46.0844 23.7873 46.4297 23.1153C46.7751 22.4433 47.0457 21.706 47.2417 20.9033C47.4377 20.0913 47.5777 19.2466 47.6617 18.3693C47.7457 17.492 47.7971 16.596 47.8157 15.6813C47.8437 14.7573 47.8577 13.8473 47.8577 12.9513ZM39.9057 13.8613H45.2957V14.7153H39.9057V13.8613ZM39.4017 17.2213H45.5617V18.0753H39.4017V17.2213ZM43.5317 19.5593L44.3157 19.3493C44.4931 19.7693 44.6751 20.222 44.8617 20.7073C45.0484 21.1926 45.2211 21.664 45.3797 22.1213C45.5477 22.5693 45.6737 22.9566 45.7577 23.2833L44.9317 23.5633C44.8477 23.2273 44.7311 22.8306 44.5817 22.3733C44.4324 21.916 44.2644 21.44 44.0777 20.9453C43.8911 20.4506 43.7091 19.9886 43.5317 19.5593ZM39.8777 23.7873L39.8077 22.9893L40.3117 22.6393L44.9177 21.6873C44.9271 21.8086 44.9411 21.9533 44.9597 22.1213C44.9877 22.28 45.0157 22.406 45.0437 22.4993C44.1757 22.686 43.4524 22.8446 42.8737 22.9753C42.2951 23.106 41.8191 23.2133 41.4457 23.2973C41.0817 23.3813 40.7971 23.456 40.5917 23.5213C40.3864 23.5773 40.2324 23.624 40.1297 23.6613C40.0271 23.6986 39.9431 23.7406 39.8777 23.7873ZM39.8777 23.7733C39.8591 23.708 39.8311 23.6193 39.7937 23.5073C39.7657 23.3953 39.7284 23.2833 39.6817 23.1713C39.6444 23.0593 39.6071 22.966 39.5697 22.8913C39.6817 22.8633 39.7844 22.7606 39.8777 22.5833C39.9804 22.406 40.0924 22.182 40.2137 21.9113C40.2697 21.7806 40.3491 21.566 40.4517 21.2673C40.5544 20.9686 40.6711 20.6186 40.8017 20.2173C40.9324 19.8066 41.0584 19.3726 41.1797 18.9153C41.3011 18.4486 41.4037 17.9866 41.4877 17.5293L42.4117 17.8373C42.2624 18.4626 42.0851 19.0973 41.8797 19.7413C41.6837 20.3853 41.4691 21.006 41.2357 21.6033C41.0117 22.2006 40.7831 22.742 40.5497 23.2273V23.2413C40.5497 23.2413 40.5124 23.26 40.4377 23.2973C40.3724 23.3346 40.2931 23.3813 40.1997 23.4373C40.1157 23.484 40.0411 23.54 39.9757 23.6053C39.9104 23.6613 39.8777 23.7173 39.8777 23.7733ZM53.2617 15.0233H58.8337V15.9053H53.2617V15.0233ZM55.2217 17.8093H57.6857V18.6913H55.2217V17.8093ZM61.8997 17.4313H62.7677V24.4733H61.8997V17.4313ZM54.8017 15.5133H55.6837C55.6744 16.652 55.6511 17.7206 55.6137 18.7193C55.5764 19.7086 55.4924 20.6233 55.3617 21.4633C55.2311 22.3033 55.0351 23.064 54.7737 23.7453C54.5217 24.4266 54.1717 25.024 53.7237 25.5373C53.6491 25.4346 53.5417 25.3226 53.4017 25.2013C53.2617 25.08 53.1357 24.9866 53.0237 24.9213C53.5837 24.296 53.9851 23.526 54.2277 22.6113C54.4704 21.6873 54.6244 20.6326 54.6897 19.4473C54.7551 18.2526 54.7924 16.9413 54.8017 15.5133ZM57.3637 17.8093H58.2317C58.2317 17.8093 58.2317 17.8373 58.2317 17.8933C58.2317 17.9493 58.2317 18.0146 58.2317 18.0893C58.2317 18.1546 58.2271 18.2106 58.2177 18.2573C58.1991 19.4333 58.1757 20.4226 58.1477 21.2253C58.1197 22.028 58.0824 22.686 58.0357 23.1993C57.9984 23.7033 57.9517 24.0953 57.8957 24.3753C57.8397 24.646 57.7651 24.842 57.6717 24.9633C57.5691 25.1126 57.4524 25.2153 57.3217 25.2713C57.2004 25.3366 57.0511 25.3786 56.8737 25.3973C56.7151 25.416 56.5051 25.4206 56.2437 25.4113C55.9917 25.4113 55.7257 25.4066 55.4457 25.3973C55.4364 25.2666 55.4084 25.1173 55.3617 24.9493C55.3244 24.7906 55.2777 24.6506 55.2217 24.5293C55.5017 24.5573 55.7537 24.5713 55.9777 24.5713C56.2111 24.5806 56.3791 24.5853 56.4817 24.5853C56.5844 24.5853 56.6684 24.5713 56.7337 24.5433C56.7991 24.5246 56.8551 24.478 56.9017 24.4033C56.9671 24.3193 57.0184 24.1513 57.0557 23.8993C57.1024 23.638 57.1444 23.2646 57.1817 22.7793C57.2191 22.2846 57.2517 21.65 57.2797 20.8753C57.3077 20.0913 57.3357 19.1346 57.3637 18.0053V17.8093ZM60.0937 14.5473H66.0297V15.4153H60.0937V14.5473ZM59.4497 16.9973H65.2037V17.8373H59.4497V16.9973ZM62.3057 20.3853H65.4977V21.2113H62.3057V20.3853ZM60.3737 12.6993L61.2977 12.8813C61.0644 13.768 60.7564 14.6126 60.3737 15.4153C60.0004 16.2086 59.5757 16.876 59.0997 17.4173C59.0531 17.3613 58.9831 17.296 58.8897 17.2213C58.7964 17.1466 58.6984 17.072 58.5957 16.9973C58.5024 16.9226 58.4184 16.8666 58.3437 16.8293C58.8104 16.3253 59.2164 15.7093 59.5617 14.9813C59.9071 14.2533 60.1777 13.4926 60.3737 12.6993ZM65.0077 16.9973H65.1617L65.3017 16.9553L65.9177 17.1653C65.7404 17.5853 65.5537 18.0193 65.3577 18.4673C65.1711 18.9153 64.9891 19.2933 64.8117 19.6013L64.0697 19.3213C64.2284 19.032 64.3917 18.6913 64.5597 18.2993C64.7277 17.898 64.8771 17.5106 65.0077 17.1373V16.9973ZM59.7437 19.2233H60.5837C60.5464 20.0726 60.4764 20.8893 60.3737 21.6733C60.2804 22.4573 60.1124 23.176 59.8697 23.8293C59.6364 24.4826 59.2911 25.038 58.8337 25.4953C58.7684 25.402 58.6751 25.2946 58.5537 25.1733C58.4324 25.052 58.3204 24.9586 58.2177 24.8933C58.6191 24.492 58.9224 23.9926 59.1277 23.3953C59.3424 22.798 59.4917 22.14 59.5757 21.4213C59.6597 20.7026 59.7157 19.97 59.7437 19.2233ZM60.3597 21.1833C60.5651 22.0793 60.8451 22.7606 61.1997 23.2273C61.5637 23.694 61.9837 24.0066 62.4597 24.1653C62.9451 24.324 63.4724 24.4033 64.0417 24.4033C64.1071 24.4033 64.2331 24.4033 64.4197 24.4033C64.6157 24.4033 64.8257 24.4033 65.0497 24.4033C65.2831 24.4033 65.5024 24.4033 65.7077 24.4033C65.9131 24.394 66.0671 24.3893 66.1697 24.3893C66.1231 24.4546 66.0811 24.5433 66.0437 24.6553C66.0064 24.7673 65.9737 24.8746 65.9457 24.9773C65.9177 25.0893 65.8944 25.1826 65.8757 25.2573H65.4137H63.9857C63.4631 25.2573 62.9777 25.206 62.5297 25.1033C62.0911 25.0006 61.6944 24.814 61.3397 24.5433C60.9851 24.2726 60.6724 23.8853 60.4017 23.3813C60.1311 22.868 59.9024 22.21 59.7157 21.4073L60.3597 21.1833ZM55.0257 13.0773L55.8797 12.7833C56.0757 13.1006 56.2764 13.4413 56.4817 13.8053C56.6964 14.16 56.8551 14.468 56.9577 14.7293L56.0757 15.0653C55.9731 14.7946 55.8191 14.4726 55.6137 14.0993C55.4177 13.7166 55.2217 13.376 55.0257 13.0773ZM67.3037 14.3793H72.4417V15.2473H67.3037V14.3793ZM70.0897 16.5213H70.9857V25.4813H70.0897V16.5213ZM67.2197 22.1493C67.6957 22.0746 68.2417 21.986 68.8577 21.8833C69.4737 21.7713 70.1224 21.6546 70.8037 21.5333C71.4944 21.412 72.1897 21.286 72.8897 21.1553L72.9317 21.9813C71.9611 22.168 70.9857 22.3593 70.0057 22.5553C69.0351 22.7513 68.1764 22.924 67.4297 23.0733L67.2197 22.1493ZM67.7797 19.7553C67.7704 19.69 67.7471 19.606 67.7097 19.5033C67.6817 19.3913 67.6491 19.284 67.6117 19.1813C67.5744 19.0786 67.5371 18.99 67.4997 18.9153C67.6117 18.8873 67.7237 18.766 67.8357 18.5513C67.9477 18.3366 68.0644 18.08 68.1857 17.7813C68.2417 17.6226 68.3304 17.3753 68.4517 17.0393C68.5731 16.694 68.7037 16.288 68.8437 15.8213C68.9837 15.3546 69.1191 14.8553 69.2497 14.3233C69.3897 13.782 69.5017 13.2453 69.5857 12.7133L70.5097 12.9093C70.3417 13.656 70.1411 14.412 69.9077 15.1773C69.6837 15.9333 69.4364 16.6566 69.1657 17.3473C68.9044 18.038 68.6384 18.6633 68.3677 19.2233V19.2373C68.3677 19.2373 68.3351 19.256 68.2697 19.2933C68.2137 19.3213 68.1484 19.3633 68.0737 19.4193C67.9991 19.4753 67.9291 19.5313 67.8637 19.5873C67.8077 19.6433 67.7797 19.6993 67.7797 19.7553ZM67.7797 19.7553V18.9573L68.3257 18.6913H72.4977V19.5593H68.8017C68.5591 19.5593 68.3444 19.578 68.1577 19.6153C67.9711 19.6526 67.8451 19.6993 67.7797 19.7553ZM74.5137 19.6153H78.7137V20.4973H74.5137V19.6153ZM78.4897 19.6153H78.6437L78.7837 19.5593L79.4557 19.8813C79.2037 20.2546 78.9191 20.67 78.6017 21.1273C78.2844 21.5753 77.9531 22.028 77.6077 22.4853C77.2717 22.9426 76.9404 23.3766 76.6137 23.7873L75.8017 23.4233C76.1191 23.022 76.4457 22.5926 76.7817 22.1353C77.1177 21.6686 77.4351 21.2253 77.7337 20.8053C78.0417 20.376 78.2937 20.0166 78.4897 19.7273V19.6153ZM74.1497 22.5833L74.7377 21.9813C75.2231 22.2613 75.7084 22.5693 76.1937 22.9053C76.6884 23.2413 77.1457 23.5773 77.5657 23.9133C77.9951 24.24 78.3451 24.5386 78.6157 24.8093L77.9997 25.5513C77.7291 25.2713 77.3791 24.954 76.9497 24.5993C76.5297 24.2446 76.0724 23.89 75.5777 23.5353C75.0924 23.1806 74.6164 22.8633 74.1497 22.5833ZM76.1377 12.7133L77.0757 12.8393C76.9264 13.446 76.7537 14.0993 76.5577 14.7993C76.3711 15.49 76.1797 16.1853 75.9837 16.8853C75.7877 17.576 75.5964 18.234 75.4097 18.8593C75.2231 19.4846 75.0504 20.0306 74.8917 20.4973H73.8697C74.0471 20.0026 74.2384 19.438 74.4437 18.8033C74.6491 18.1593 74.8544 17.4826 75.0597 16.7733C75.2651 16.064 75.4611 15.3593 75.6477 14.6593C75.8344 13.9593 75.9977 13.3106 76.1377 12.7133ZM73.1417 14.3793H79.5257V15.2613H73.1417V14.3793ZM72.5957 17.0113H80.0297V17.8933H72.5957V17.0113ZM87.7717 20.8193H93.7077V21.6873H87.7717V20.8193ZM87.1417 24.1513H94.0717V25.0333H87.1417V24.1513ZM90.3197 18.9713H91.2297V24.9073H90.3197V18.9713ZM87.9677 14.6313H93.6377V15.4993H87.9677V14.6313ZM87.5617 17.6413H93.9317V18.5233H87.5617V17.6413ZM90.3197 12.7273H91.2297V18.0753H90.3197V12.7273ZM81.2897 14.0293H87.6457V14.8273H81.2897V14.0293ZM81.2057 22.2193H87.4917V23.0313H81.2057V22.2193ZM84.0057 16.3673H84.8877V18.0473H84.0057V16.3673ZM84.0757 18.1033H84.8317V20.6793H84.8877V25.5513H84.0197V20.6793H84.0757V18.1033ZM82.5357 12.7273H83.3617V16.0033H85.5737V12.7273H86.4277V16.7593H82.5357V12.7273ZM82.5917 18.4953V20.3013H86.2037V18.4953H82.5917ZM81.7657 17.7393H87.0297V21.0433H81.7657V17.7393ZM95.3597 18.9573H107.96V19.8953H95.3597V18.9573ZM96.7597 13.6793H105.944V14.6033H96.7597V13.6793ZM105.65 13.6793H105.888L106.098 13.6233L106.812 14.1553C106.382 14.5753 105.883 15 105.314 15.4293C104.754 15.8493 104.17 16.246 103.564 16.6193C102.957 16.9926 102.374 17.3146 101.814 17.5853C101.776 17.5106 101.716 17.436 101.632 17.3613C101.557 17.2773 101.482 17.198 101.408 17.1233C101.333 17.0393 101.263 16.9693 101.198 16.9133C101.72 16.6706 102.266 16.3766 102.836 16.0313C103.405 15.686 103.937 15.3266 104.432 14.9533C104.936 14.58 105.342 14.2253 105.65 13.8893V13.6793ZM101.198 16.9133H102.164V24.2633C102.164 24.5993 102.112 24.8466 102.01 25.0053C101.916 25.164 101.739 25.2853 101.478 25.3693C101.226 25.444 100.871 25.4906 100.414 25.5093C99.9657 25.528 99.4011 25.5373 98.7197 25.5373C98.7011 25.444 98.6684 25.3413 98.6217 25.2293C98.5751 25.1173 98.5237 25.0006 98.4677 24.8793C98.4211 24.7673 98.3744 24.6646 98.3277 24.5713C98.7104 24.5806 99.0697 24.59 99.4057 24.5993C99.7511 24.6086 100.045 24.6086 100.288 24.5993C100.54 24.5993 100.717 24.5993 100.82 24.5993C100.96 24.5806 101.058 24.548 101.114 24.5013C101.17 24.464 101.198 24.3846 101.198 24.2633V16.9133ZM118.665 13.7913H123.957V14.7013H118.665V13.7913ZM123.649 13.7913H123.803L123.971 13.7493L124.587 13.9313C124.326 15.9753 123.887 17.7533 123.271 19.2653C122.655 20.768 121.899 22.0373 121.003 23.0733C120.107 24.1 119.108 24.9166 118.007 25.5233C117.97 25.4486 117.914 25.36 117.839 25.2573C117.774 25.1546 117.699 25.0566 117.615 24.9633C117.531 24.87 117.452 24.7906 117.377 24.7253C118.422 24.2026 119.374 23.456 120.233 22.4853C121.092 21.5053 121.815 20.3106 122.403 18.9013C122.991 17.492 123.406 15.8633 123.649 14.0153V13.7913ZM119.939 14.5473C120.163 16.1246 120.485 17.5853 120.905 18.9293C121.334 20.264 121.894 21.4353 122.585 22.4433C123.285 23.442 124.162 24.2213 125.217 24.7813C125.133 24.8373 125.049 24.912 124.965 25.0053C124.881 25.0986 124.797 25.192 124.713 25.2853C124.638 25.388 124.578 25.486 124.531 25.5793C123.448 24.9353 122.548 24.086 121.829 23.0313C121.11 21.9766 120.532 20.7446 120.093 19.3353C119.654 17.926 119.304 16.3766 119.043 14.6873L119.939 14.5473ZM112.673 13.7913H117.475V14.7013H112.673V13.7913ZM117.111 13.7913H117.279L117.447 13.7493L118.035 13.9313C117.839 15.8446 117.503 17.548 117.027 19.0413C116.56 20.5253 115.982 21.8086 115.291 22.8913C114.6 23.9646 113.821 24.842 112.953 25.5233C112.916 25.4486 112.855 25.3646 112.771 25.2713C112.696 25.178 112.612 25.0846 112.519 24.9913C112.435 24.9073 112.351 24.842 112.267 24.7953C112.883 24.3473 113.452 23.778 113.975 23.0873C114.507 22.3966 114.983 21.594 115.403 20.6793C115.823 19.7646 116.178 18.752 116.467 17.6413C116.756 16.5213 116.971 15.3173 117.111 14.0293V13.7913ZM112.827 16.7593L113.541 16.2413C113.98 16.7733 114.432 17.3426 114.899 17.9493C115.366 18.556 115.814 19.1673 116.243 19.7833C116.672 20.3993 117.06 20.992 117.405 21.5613C117.76 22.1306 118.044 22.6393 118.259 23.0873L117.461 23.7173C117.256 23.26 116.98 22.7466 116.635 22.1773C116.299 21.5986 115.921 20.9966 115.501 20.3713C115.081 19.7366 114.642 19.1113 114.185 18.4953C113.728 17.8793 113.275 17.3006 112.827 16.7593ZM131.937 12.7693H132.861V16.7873C132.861 17.0113 132.926 17.1606 133.057 17.2353C133.197 17.31 133.496 17.3473 133.953 17.3473C134.046 17.3473 134.196 17.3473 134.401 17.3473C134.616 17.3473 134.858 17.3473 135.129 17.3473C135.4 17.3473 135.675 17.3473 135.955 17.3473C136.235 17.3473 136.487 17.3473 136.711 17.3473C136.944 17.3473 137.122 17.3473 137.243 17.3473C137.504 17.3473 137.7 17.3053 137.831 17.2213C137.962 17.128 138.055 16.9553 138.111 16.7033C138.167 16.442 138.209 16.0593 138.237 15.5553C138.34 15.63 138.475 15.7 138.643 15.7653C138.82 15.8213 138.974 15.868 139.105 15.9053C139.058 16.512 138.979 16.9833 138.867 17.3193C138.755 17.6553 138.578 17.8886 138.335 18.0193C138.092 18.1406 137.742 18.2013 137.285 18.2013C137.22 18.2013 137.07 18.2013 136.837 18.2013C136.613 18.2013 136.352 18.2013 136.053 18.2013C135.754 18.2013 135.451 18.2013 135.143 18.2013C134.844 18.2013 134.583 18.2013 134.359 18.2013C134.135 18.2013 133.99 18.2013 133.925 18.2013C133.412 18.2013 133.006 18.164 132.707 18.0893C132.418 18.0053 132.217 17.8606 132.105 17.6553C131.993 17.45 131.937 17.156 131.937 16.7733V12.7693ZM137.509 13.5813L138.223 14.2813C137.738 14.4773 137.178 14.664 136.543 14.8413C135.908 15.0186 135.25 15.182 134.569 15.3313C133.897 15.4806 133.244 15.616 132.609 15.7373C132.581 15.6346 132.534 15.5133 132.469 15.3733C132.413 15.2333 132.357 15.1166 132.301 15.0233C132.917 14.902 133.547 14.7666 134.191 14.6173C134.844 14.4586 135.46 14.2906 136.039 14.1133C136.618 13.9266 137.108 13.7493 137.509 13.5813ZM131.937 19.4473H138.503V25.4673H137.579V20.2453H132.833V25.5233H131.937V19.4473ZM132.399 21.7433H137.915V22.5133H132.399V21.7433ZM132.371 24.0813H137.943V24.8793H132.371V24.0813ZM126.211 20.1893C126.622 20.0773 127.088 19.9466 127.611 19.7973C128.143 19.648 128.703 19.4846 129.291 19.3073C129.888 19.13 130.481 18.9526 131.069 18.7753L131.195 19.6433C130.374 19.8953 129.548 20.152 128.717 20.4133C127.886 20.6746 127.144 20.9033 126.491 21.0993L126.211 20.1893ZM126.379 15.5693H130.999V16.4513H126.379V15.5693ZM128.381 12.7133H129.291V24.4033C129.291 24.674 129.254 24.8793 129.179 25.0193C129.114 25.1686 128.992 25.2853 128.815 25.3693C128.647 25.4346 128.414 25.4766 128.115 25.4953C127.826 25.5233 127.452 25.5326 126.995 25.5233C126.976 25.4113 126.934 25.2713 126.869 25.1033C126.813 24.9353 126.757 24.7906 126.701 24.6693C127.028 24.6786 127.322 24.6833 127.583 24.6833C127.844 24.6833 128.022 24.6786 128.115 24.6693C128.208 24.6693 128.274 24.6506 128.311 24.6133C128.358 24.576 128.381 24.506 128.381 24.4033V12.7133ZM142.675 12.9373L143.487 12.6853C143.636 12.984 143.786 13.3106 143.935 13.6653C144.084 14.0106 144.196 14.3046 144.271 14.5473L143.403 14.8553C143.347 14.594 143.244 14.2813 143.095 13.9173C142.955 13.5533 142.815 13.2266 142.675 12.9373ZM140.379 14.9953H146.609V15.8913H140.379V14.9953ZM142.619 17.8233H145.377V18.7053H142.619V17.8233ZM145.041 17.8233H145.937C145.937 17.8233 145.937 17.856 145.937 17.9213C145.937 17.9773 145.937 18.0426 145.937 18.1173C145.937 18.1826 145.932 18.2386 145.923 18.2853C145.904 19.4426 145.881 20.4226 145.853 21.2253C145.825 22.0186 145.792 22.6673 145.755 23.1713C145.718 23.6753 145.666 24.0673 145.601 24.3473C145.545 24.6273 145.47 24.8233 145.377 24.9353C145.265 25.0846 145.148 25.192 145.027 25.2573C144.906 25.3226 144.752 25.36 144.565 25.3693C144.397 25.388 144.173 25.3973 143.893 25.3973C143.622 25.3973 143.338 25.388 143.039 25.3693C143.02 25.2386 142.992 25.0893 142.955 24.9213C142.918 24.7626 142.862 24.618 142.787 24.4873C143.095 24.5153 143.37 24.534 143.613 24.5433C143.865 24.5526 144.047 24.5573 144.159 24.5573C144.262 24.5573 144.346 24.5433 144.411 24.5153C144.476 24.4966 144.532 24.4453 144.579 24.3613C144.644 24.2773 144.7 24.1093 144.747 23.8573C144.794 23.6053 144.836 23.2366 144.873 22.7513C144.91 22.2566 144.943 21.6266 144.971 20.8613C144.999 20.0866 145.022 19.144 145.041 18.0333V17.8233ZM148.023 15.3313H153.189V16.2133H148.023V15.3313ZM148.373 12.6993L149.325 12.8533C149.157 13.7306 148.947 14.5893 148.695 15.4293C148.452 16.26 148.168 17.0346 147.841 17.7533C147.514 18.4626 147.15 19.088 146.749 19.6293C146.702 19.564 146.632 19.494 146.539 19.4193C146.455 19.3353 146.362 19.2513 146.259 19.1673C146.166 19.074 146.086 18.9993 146.021 18.9433C146.404 18.4486 146.744 17.87 147.043 17.2073C147.342 16.5353 147.603 15.8166 147.827 15.0513C148.051 14.286 148.233 13.502 148.373 12.6993ZM151.299 15.7793L152.223 15.8913C151.971 17.506 151.612 18.9246 151.145 20.1473C150.688 21.37 150.067 22.4293 149.283 23.3253C148.508 24.212 147.528 24.9586 146.343 25.5653C146.315 25.4906 146.264 25.402 146.189 25.2993C146.124 25.206 146.054 25.108 145.979 25.0053C145.914 24.9026 145.848 24.8186 145.783 24.7533C146.922 24.2213 147.855 23.5446 148.583 22.7233C149.32 21.8926 149.904 20.9033 150.333 19.7553C150.762 18.6073 151.084 17.282 151.299 15.7793ZM148.359 16.1713C148.583 17.4873 148.9 18.71 149.311 19.8393C149.731 20.9686 150.268 21.9533 150.921 22.7933C151.574 23.6333 152.372 24.2773 153.315 24.7253C153.25 24.7813 153.17 24.856 153.077 24.9493C152.993 25.0426 152.914 25.136 152.839 25.2293C152.764 25.332 152.704 25.4253 152.657 25.5093C151.677 25.0053 150.851 24.3053 150.179 23.4093C149.516 22.5133 148.975 21.4633 148.555 20.2593C148.135 19.0553 147.799 17.7393 147.547 16.3113L148.359 16.1713ZM142.087 15.4153H142.983V18.8313C142.983 19.606 142.932 20.3853 142.829 21.1693C142.736 21.944 142.535 22.7 142.227 23.4373C141.919 24.1653 141.452 24.8653 140.827 25.5373C140.743 25.4346 140.631 25.3273 140.491 25.2153C140.36 25.1033 140.239 25.0053 140.127 24.9213C140.715 24.3146 141.144 23.6706 141.415 22.9893C141.695 22.2986 141.877 21.5986 141.961 20.8893C142.045 20.18 142.087 19.494 142.087 18.8313V15.4153ZM154.631 16.7733H166.923V17.7253H154.631V16.7733ZM161.393 17.1513C161.701 18.29 162.116 19.354 162.639 20.3433C163.171 21.3326 163.81 22.196 164.557 22.9333C165.313 23.6613 166.172 24.2306 167.133 24.6413C167.058 24.7066 166.974 24.7906 166.881 24.8933C166.797 25.0053 166.713 25.1126 166.629 25.2153C166.554 25.3273 166.489 25.4253 166.433 25.5093C165.434 25.0333 164.548 24.3986 163.773 23.6053C163.008 22.812 162.35 21.888 161.799 20.8333C161.258 19.7786 160.814 18.6306 160.469 17.3893L161.393 17.1513ZM160.287 12.7273H161.281C161.281 13.3153 161.262 13.978 161.225 14.7153C161.197 15.4433 161.127 16.2086 161.015 17.0113C160.903 17.8046 160.721 18.6073 160.469 19.4193C160.217 20.222 159.862 21.0013 159.405 21.7573C158.948 22.5133 158.364 23.2133 157.655 23.8573C156.955 24.5013 156.096 25.0566 155.079 25.5233C155.004 25.402 154.897 25.2666 154.757 25.1173C154.626 24.968 154.496 24.8466 154.365 24.7533C155.364 24.3146 156.204 23.7966 156.885 23.1993C157.566 22.5926 158.122 21.9346 158.551 21.2253C158.99 20.5066 159.326 19.7646 159.559 18.9993C159.802 18.234 159.97 17.4733 160.063 16.7173C160.156 15.9613 160.212 15.2426 160.231 14.5613C160.259 13.88 160.278 13.2686 160.287 12.7273Z"
            fill="white" />
        </svg>

      </div>

      <!-- 颜色选择区域 -->
      <div class="px-6 space-y-6">
        <!-- 区域1 颜色选择 -->
        <div>
          <div class="flex items-center justify-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">区域1</h3>
          </div>
          <div class="grid grid-cols-6 gap-x-4 gap-y-3 justify-items-center">
            <div v-for="texture in aTextureNames" :key="texture" class="flex flex-col items-center">
              <button type="button" @click="switchToATexture(texture)" :class="[
                'w-14 h-14 md:w-16 md:h-16 rounded-[18px] border border-gray-200 shadow-sm transition-transform duration-200',
                selectedATexture === texture ? 'ring-2 ring-offset-2 ring-blue-400 scale-105' : 'hover:scale-105'
              ]" :style="{ backgroundColor: getColorForTexture('A', texture) }" />
              <div class="text-center leading-tight">
                <div class="text-[13px] text-gray-800">{{ getColorName('A', texture) }}</div>
                <div class="text-[11px] text-gray-500">{{ getColorEn('A', texture) }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 分隔线 -->
        <div class="border-t border-gray-200"></div>

        <!-- 区域2 颜色选择 -->
        <div>
          <div class="flex items-center justify-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">区域2</h3>
          </div>
          <div class="grid grid-cols-6 gap-x-4 gap-y-3 justify-items-center">
            <div v-for="texture in bTextureNames" :key="texture" class="flex flex-col items-center">
              <button type="button" @click="switchToBTexture(texture)" :class="[
                'w-14 h-14 md:w-16 md:h-16 rounded-[18px] border border-gray-200 shadow-sm transition-transform duration-200',
                selectedBTexture === texture ? 'ring-2 ring-offset-2 ring-green-500 scale-105' : 'hover:scale-105'
              ]" :style="{ backgroundColor: getColorForTexture('B', texture) }" />
              <div class="text-center leading-tight">
                <div class="text-[13px] text-gray-800">{{ getColorName('B', texture) }}</div>
                <div class="text-[11px] text-gray-500">{{ getColorEn('B', texture) }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 定制完成按钮 -->
        <div class="flex justify-center mt-8">
          <button
            type="button"
            @click="showConfirm = true"
            class="w-full max-w-[420px] h-16 rounded-[32px] bg-gradient-to-b from-[#F7E3EA] to-[#EED6E3] flex items-center justify-center px-6 shadow-md border border-[#EEC9D9] relative"
            style="backdrop-filter: blur(2px);"
          >
            <span class="text-white text-xl font-medium flex-1 text-center">定制完成</span>
            <svg class="w-6 h-6 text-white absolute right-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>

        <!-- 确认弹窗 -->
        <div v-if="showConfirm" class="fixed inset-0 z-[200]">
          <div class="absolute inset-0 bg-black/40" @click="onCancel"></div>
          <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[347.02px] h-[152.2px] bg-[#F6DBE1] rounded-[45px] shadow-xl border border-[#F1CFE0] text-center relative select-none">
            <!-- 标题 -->
            <div class="absolute left-1/2 -translate-x-1/2 top-[24px] w-[141.92px] text-white text-[14px] leading-[21px] font-medium">确认定制？</div>
            <!-- 按钮组：宽 309.5，间距约 5px，按钮 152.2x50.73 -->
            <div class="absolute left-1/2 -translate-x-1/2 bottom-[24.7px] w-[309.5px] flex items-center justify-between gap-[5px]">
              <button @click="onCancel" class="w-[152.2px] h-[50.73px] rounded-[45px] bg-white/25 text-white text-[14px] font-medium">否</button>
              <button @click="onConfirm" class="w-[152.2px] h-[50.73px] rounded-[45px] bg-white/25 text-white text-[14px] font-medium">是</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted, nextTick } from 'vue'
import * as THREE from 'three'
import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js'
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js'
import { RGBELoader } from 'three/examples/jsm/loaders/RGBELoader.js'


// 环境检测和路径适配工具
const getTexturePath = (folder: 'A' | 'B', filename: string): string => {
  // 检测环境
  const isDev = import.meta.env.DEV
  const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'

  // 生产环境路径
  const prodPath = `/tietu/${folder}/${filename}`

  // 开发环境路径
  const devPath = `/tietu/${folder}/${filename}`


  return isDev ? devPath : prodPath
}

// 响应式数据
const containerRef = ref<HTMLElement>()
const loading = ref(true)
const loadingProgress = ref(0)
const error = ref('')
const selectedEnvironment = ref('studio')
const isAnimating = ref(true)
const showGestureHint = ref(true)
const showControlPanel = ref(false)
const cameraPosition = ref({ x: 0, y: 0, z: 5 })
// 确认弹窗
const showConfirm = ref(false)

// A和B贴图文件名数组
const aTextureNames = ['A1.png', 'A2.png', 'A3.png', 'A4.png', 'A5.png', 'A6.png',]
const bTextureNames = ['B1.png', 'B2.png', 'B3.png', 'B4.png', 'B5.png', 'B6.png',]

// 当前选中的贴图
const selectedATexture = ref('A2.png')
const selectedBTexture = ref('B3.png')

// 贴图缓存
const textureCache: Record<string, THREE.Texture> = {}

// 添加灯光强度控制
const lightingIntensity = ref({
  ambient: 3.0,
  directional: 3.0,
  fill: 2.0,
  additional: 1.5
})

// 添加Mesh列表
const meshList = ref<Array<{ name: string, index: number, mesh: THREE.Mesh }>>([])



// Three.js 相关变量
let scene: THREE.Scene
let camera: THREE.PerspectiveCamera
let renderer: THREE.WebGLRenderer
let controls: OrbitControls
let shoeModel: THREE.Group
let mixer: THREE.AnimationMixer
let animationId: number

// 添加灯光对象引用
let ambientLight: THREE.AmbientLight
let directionalLight: THREE.DirectionalLight
let fillLight: THREE.DirectionalLight
let topLight: THREE.DirectionalLight
let bottomLight: THREE.DirectionalLight
let leftLight: THREE.DirectionalLight
let rightLight: THREE.DirectionalLight
let spotLight: THREE.SpotLight

// 切换控制面板显示
const toggleControlPanel = () => {
  showControlPanel.value = !showControlPanel.value
}

// 更新相机位置
const updateCameraPosition = () => {
  if (camera) {
    camera.position.set(cameraPosition.value.x, cameraPosition.value.y, cameraPosition.value.z)
    camera.updateProjectionMatrix()
  }
}

// 更新灯光强度
const updateLightingIntensity = () => {
  if (ambientLight) ambientLight.intensity = lightingIntensity.value.ambient
  if (directionalLight) directionalLight.intensity = lightingIntensity.value.directional
  if (fillLight) fillLight.intensity = lightingIntensity.value.fill
  if (topLight) topLight.intensity = lightingIntensity.value.additional
  if (bottomLight) bottomLight.intensity = lightingIntensity.value.additional * 0.8
  if (leftLight) leftLight.intensity = lightingIntensity.value.additional
  if (rightLight) rightLight.intensity = lightingIntensity.value.additional
  if (spotLight) spotLight.intensity = lightingIntensity.value.directional * 0.8
}

// 获取指定Mesh的函数
const getMeshByName = (name: string): THREE.Mesh | null => {
  const found = meshList.value.find(item => item.name === name)
  return found ? found.mesh : null
}

const getMeshByIndex = (index: number): THREE.Mesh | null => {
  const found = meshList.value.find(item => item.index === index)
  return found ? found.mesh : null
}



const switchToATexture = (textureName: string) => {
  if (!aTextureNames.includes(textureName)) {
    return
  }

  selectedATexture.value = textureName

  // 使用环境适配的路径
  const texturePath = getTexturePath('A', textureName)
  applyTextureToMeshA(texturePath)
}



const switchToBTexture = (textureName: string) => {
  if (!bTextureNames.includes(textureName)) {
    return
  }

  selectedBTexture.value = textureName


  // 使用环境适配的路径
  const texturePath = getTexturePath('B', textureName)
  applyTextureToMeshB(texturePath)
}

// 应用贴图到A mesh
const applyTextureToMeshA = (texturePath: string) => {
  if (!shoeModel) return

  const textureLoader = new THREE.TextureLoader()

  // 添加错误处理和备用路径
  const tryLoadTexture = (path: string, fallbackPaths: string[] = []) => {
    textureLoader.load(
      path,
      (texture) => {
        // 成功加载贴图
        // UV贴图设置 - 不重复，按UV坐标映射
        texture.wrapS = THREE.ClampToEdgeWrapping
        texture.wrapT = THREE.ClampToEdgeWrapping
        texture.repeat.set(1, 1)
        texture.offset.set(0, 0)
        texture.minFilter = THREE.LinearMipmapLinearFilter
        texture.magFilter = THREE.LinearFilter
        texture.flipY = false // 根据需要调整Y轴翻转

        let appliedCount = 0

        // 查找名称为'A'的mesh（精确匹配）
        shoeModel.traverse((child) => {
          if (child instanceof THREE.Mesh) {
            const meshName = child.name.trim()
            // 精确匹配名称为"A"的Mesh
            if (meshName === 'A') {

              if (child.material instanceof THREE.MeshStandardMaterial) {
                // 克隆材质避免影响其他使用相同材质的对象
                const newMaterial = child.material.clone()
                newMaterial.map = texture
                newMaterial.needsUpdate = true
                child.material = newMaterial
                appliedCount++
              } else if (Array.isArray(child.material)) {
                // 如果是材质数组，更新所有材质
                child.material = child.material.map((mat) => {
                  if (mat instanceof THREE.MeshStandardMaterial) {
                    const newMat = mat.clone()
                    newMat.map = texture
                    newMat.needsUpdate = true
                    return newMat
                  }
                  return mat
                })
                appliedCount++
              }
            }
          }
        })

        if (appliedCount === 0) {
          shoeModel.traverse((child) => {
            if (child instanceof THREE.Mesh) {
            }
          })
        } else {
        }
      },
      (progress) => {
        console.log(`A贴图加载进度: ${path}`, progress)
      },
      (error) => {
        console.error(`A贴图加载失败: ${path}`, error)

        // 尝试备用路径
        if (fallbackPaths.length > 0) {
          const nextPath = fallbackPaths.shift()!
          tryLoadTexture(nextPath, fallbackPaths)
        } else {
        }
      }
    )
  }

  // 定义多个可能的路径
  const fileName = texturePath.split('/').pop()!
  const possiblePaths = [
    texturePath, // 主路径
    `/assets/tietu/A/${fileName}`, // 备用路径1
    `./tietu/A/${fileName}`, // 备用路径2
    `./src/assets/tietu/A/${fileName}` // 备用路径3
  ]

  const mainPath = possiblePaths.shift()!
  tryLoadTexture(mainPath, possiblePaths)
}

// 应用贴图到B mesh
const applyTextureToMeshB = (texturePath: string) => {
  if (!shoeModel) return

  const textureLoader = new THREE.TextureLoader()

  // 添加错误处理和备用路径
  const tryLoadTexture = (path: string, fallbackPaths: string[] = []) => {
    textureLoader.load(
      path,
      (texture) => {
        // 成功加载贴图

        // UV贴图设置 - 不重复，按UV坐标映射
        texture.wrapS = THREE.ClampToEdgeWrapping
        texture.wrapT = THREE.ClampToEdgeWrapping
        texture.repeat.set(1, 1)
        texture.offset.set(0, 0)
        texture.minFilter = THREE.LinearMipmapLinearFilter
        texture.magFilter = THREE.LinearFilter
        texture.flipY = false // 根据需要调整Y轴翻转

        let appliedCount = 0

        // 查找名称为'B'的mesh（精确匹配）
        shoeModel.traverse((child) => {
          if (child instanceof THREE.Mesh) {
            const meshName = child.name.trim()
            // 精确匹配名称为"B"的Mesh
            if (meshName === 'B') {

              if (child.material instanceof THREE.MeshStandardMaterial) {
                // 克隆材质避免影响其他使用相同材质的对象
                const newMaterial = child.material.clone()
                newMaterial.map = texture
                newMaterial.needsUpdate = true
                child.material = newMaterial
                appliedCount++
              } else if (Array.isArray(child.material)) {
                // 如果是材质数组，更新所有材质
                child.material = child.material.map((mat) => {
                  if (mat instanceof THREE.MeshStandardMaterial) {
                    const newMat = mat.clone()
                    newMat.map = texture
                    newMat.needsUpdate = true
                    return newMat
                  }
                  return mat
                })
                appliedCount++
              }
            }
          }
        })

        if (appliedCount === 0) {
          // 输出所有可用的Mesh名称供参考
          shoeModel.traverse((child) => {
            if (child instanceof THREE.Mesh) {
            }
          })
        } else {
        }
      },
      (progress) => {
      },
      (error) => {

        // 尝试备用路径
        if (fallbackPaths.length > 0) {
          const nextPath = fallbackPaths.shift()!
          tryLoadTexture(nextPath, fallbackPaths)
        } else {
        }
      }
    )
  }

  // 定义多个可能的路径
  const fileName = texturePath.split('/').pop()!
  const possiblePaths = [
    texturePath, // 主路径
    `/assets/tietu/B/${fileName}`, // 备用路径1
    `./tietu/B/${fileName}`, // 备用路径2
    `./src/assets/tietu/B/${fileName}` // 备用路径3
  ]

  const mainPath = possiblePaths.shift()!
  tryLoadTexture(mainPath, possiblePaths)
}




// 初始化Three.js
const initThree = async () => {
  if (!containerRef.value) return

  try {
    // 创建场景
    scene = new THREE.Scene()
    // 移除场景背景，保持透明
    scene.background = null
    // 确保没有雾效
    scene.fog = null
    // 确保没有环境贴图
    scene.environment = null

    // 创建相机
    const container = containerRef.value
    camera = new THREE.PerspectiveCamera(
      50, // 减小视野角度，让模型看起来更合适
      container.clientWidth / container.clientHeight,
      0.1,
      1000
    )
    camera.position.set(cameraPosition.value.x, cameraPosition.value.y, cameraPosition.value.z) // 使用响应式数据中的相机位置

    // 创建渲染器
    renderer = new THREE.WebGLRenderer({
      antialias: true,
      alpha: true, // 启用透明背景
      preserveDrawingBuffer: true, // 用于截图
      premultipliedAlpha: false // 确保透明度正确处理
    })


    renderer.setSize(container.clientWidth, container.clientHeight)
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2))
    renderer.shadowMap.enabled = true
    renderer.shadowMap.type = THREE.PCFSoftShadowMap
    // 禁用色调映射，避免颜色偏移
    renderer.toneMapping = THREE.ACESFilmicToneMapping
    renderer.toneMappingExposure = 2.0  // 标准曝光度
    renderer.outputColorSpace = THREE.SRGBColorSpace
    // 设置完全透明背景
    renderer.setClearColor(0x000000, 0) // 完全透明


    // 禁用任何可能的颜色处理
    renderer.autoClear = true
    renderer.autoClearColor = true
    renderer.autoClearDepth = true
    renderer.autoClearStencil = true
    // 确保canvas元素也是透明的
    renderer.domElement.style.background = 'transparent'
    renderer.domElement.style.opacity = '1'

    // 确保canvas能接收鼠标事件
    renderer.domElement.style.pointerEvents = 'auto'
    renderer.domElement.style.touchAction = 'none'
    renderer.domElement.style.userSelect = 'none'


    container.appendChild(renderer.domElement)

    // 创建控制器
    controls = new OrbitControls(camera, renderer.domElement)
    controls.enableDamping = true
    controls.dampingFactor = 0.05
    controls.enableZoom = true
    controls.enablePan = false
    controls.enableRotate = true

    // 设置旋转中心点
    controls.target.set(0, 0, 0)

    // 设置距离限制
    controls.maxDistance = 10
    controls.minDistance = 2

    // 设置垂直旋转角度范围（重要！）
    // controls.minPolarAngle = 0 // 允许从顶部看
    // controls.maxPolarAngle = Math.PI // 允许从底部看

    const fixedPolarAngle = Math.PI / 2 // 固定为水平角度（90°）

    controls.minPolarAngle = fixedPolarAngle
    controls.maxPolarAngle = fixedPolarAngle


    // 设置水平旋转范围（无限制）
    controls.minAzimuthAngle = -Infinity
    controls.maxAzimuthAngle = Infinity

    // 确保鼠标/触摸事件正确处理
    controls.mouseButtons = {
      LEFT: THREE.MOUSE.ROTATE,
      MIDDLE: THREE.MOUSE.DOLLY,
      RIGHT: THREE.MOUSE.PAN
    }

    // 触摸事件设置
    controls.touches = {
      ONE: THREE.TOUCH.ROTATE,
      TWO: THREE.TOUCH.DOLLY_PAN
    }

    // 添加光照
    setupLighting()

    // 加载模型
    await loadShoeModel()

    // 开始渲染循环
    animate()

    // 设置响应式
    setupResponsive()

    loading.value = false

    // 3秒后隐藏手势提示
    setTimeout(() => {
      showGestureHint.value = false
    }, 3000)

  } catch (err) {
    console.error('初始化Three.js失败:', err)
    error.value = '初始化失败，请刷新页面重试'
    loading.value = false
  }
}

// 设置光照
const setupLighting = () => {
  // 环境光 - 使用白光，避免色彩偏移
  ambientLight = new THREE.AmbientLight(0xffffff, lightingIntensity.value.ambient)
  scene.add(ambientLight)

  // 主光源 - 使用纯白光
  directionalLight = new THREE.DirectionalLight(0xffffff, lightingIntensity.value.directional)
  directionalLight.position.set(5, 5, 5)
  directionalLight.castShadow = true
  directionalLight.shadow.mapSize.width = 2048
  directionalLight.shadow.mapSize.height = 2048
  scene.add(directionalLight)

  // 补充光源 - 使用纯白光
  fillLight = new THREE.DirectionalLight(0xffffff, lightingIntensity.value.fill)
  fillLight.position.set(-5, 0, -5)
  scene.add(fillLight)

  // 添加顶部光源
  topLight = new THREE.DirectionalLight(0xffffff, lightingIntensity.value.additional)
  topLight.position.set(0, 10, 0)
  scene.add(topLight)

  // 添加底部光源
  bottomLight = new THREE.DirectionalLight(0xffffff, lightingIntensity.value.additional * 0.8)
  bottomLight.position.set(0, -10, 0)
  scene.add(bottomLight)

  // 添加左侧光源
  leftLight = new THREE.DirectionalLight(0xffffff, lightingIntensity.value.additional)
  leftLight.position.set(-10, 0, 0)
  scene.add(leftLight)

  // 添加右侧光源
  rightLight = new THREE.DirectionalLight(0xffffff, lightingIntensity.value.additional)
  rightLight.position.set(10, 0, 0)
  scene.add(rightLight)

  // 添加前方聚光灯
  spotLight = new THREE.SpotLight(0xffffff, lightingIntensity.value.directional * 0.8, 100, Math.PI / 6, 0.5)
  spotLight.position.set(0, 0, 15)
  spotLight.target.position.set(0, 0, 0)
  spotLight.castShadow = true
  scene.add(spotLight)
  scene.add(spotLight.target)
}

// 修改加载鞋子模型函数
const loadShoeModel = async () => {
  const loader = new GLTFLoader()

  return new Promise((resolve, reject) => {
    loader.load(
      '/xie.gltf',
      (gltf) => {
        shoeModel = gltf.scene

        // 设置模型属性 - 放大3倍
        shoeModel.scale.set(11, 11, 11)
        shoeModel.position.set(0, 0, 0)

        // 遍历模型，设置材质和阴影
        let meshIndex = 0
        shoeModel.traverse((child) => {
          if (child instanceof THREE.Mesh) {
            // 保存原始材质到userData
            if (child.material) {
              child.userData.originalMaterial = child.material.clone()
            }

            child.castShadow = true
            child.receiveShadow = true

            // 确保材质没有额外的颜色偏移
            if (child.material) {
              if (Array.isArray(child.material)) {
                child.material.forEach((mat) => {
                  if (mat instanceof THREE.MeshStandardMaterial) {
                    // 重置可能的颜色偏移
                    mat.envMapIntensity = 0 // 移除环境反射
                  }
                })
              } else if (child.material instanceof THREE.MeshStandardMaterial) {
                // 重置可能的颜色偏移
                child.material.envMapIntensity = 0 // 移除环境反射
              }
              child.material.needsUpdate = true
            }

            meshList.value.push({ name: child.name || `Mesh ${meshIndex}`, index: meshIndex, mesh: child })
            meshIndex++
          }
        })

        scene.add(shoeModel)

        // 如果有动画，设置动画混合器
        if (gltf.animations.length > 0) {
          mixer = new THREE.AnimationMixer(shoeModel)
          gltf.animations.forEach((clip) => {
            const action = mixer.clipAction(clip)
            action.play()
          })
        }

        resolve(gltf)
      },
      (progress) => {
        loadingProgress.value = Math.round((progress.loaded / progress.total) * 100)
      },
      (err) => {
        console.error('模型加载失败:', err)
        reject(err)
      }
    )
  })
}

// 渲染循环
const animate = () => {
  animationId = requestAnimationFrame(animate)

  // 更新控制器
  controls.update()

  // 更新动画
  if (mixer && isAnimating.value) {
    mixer.update(0.016)
  }

  // 自动旋转
  if (shoeModel && isAnimating.value) {
    shoeModel.rotation.y += 0.005
  }

  // 渲染
  renderer.render(scene, camera)
}


// 改变环境
const changeEnvironment = () => {
  const environments: { [key: string]: number } = {
    studio: 0xf0f0f0,
    outdoor: 0x87CEEB,
    dark: 0x222222
  }

  scene.background = new THREE.Color(environments[selectedEnvironment.value])
}

// 切换动画
const toggleAnimation = () => {
  isAnimating.value = !isAnimating.value
}

// 重置视角
const resetView = () => {
  cameraPosition.value = { x: 0, y: 0, z: 5 }
  updateCameraPosition()
  controls.reset()
  if (shoeModel) {
    shoeModel.rotation.set(0, 0, 0)
  }

  // 重置灯光强度
  lightingIntensity.value = {
    ambient: 3.0,
    directional: 3.0,
    fill: 2.0,
    additional: 1.5
  }
  updateLightingIntensity()
}

// 截图
const takeScreenshot = () => {
  const canvas = renderer.domElement
  const link = document.createElement('a')
  link.download = 'shoe-screenshot.png'
  link.href = canvas.toDataURL()
  link.click()
}

// 全屏
const toggleFullscreen = () => {
  if (!document.fullscreenElement) {
    containerRef.value?.requestFullscreen()
  } else {
    document.exitFullscreen()
  }
}

// 重试加载
const retryLoad = () => {
  error.value = ''
  loading.value = true
  loadingProgress.value = 0
  initThree()
}

// 响应式设置
const setupResponsive = () => {
  const handleResize = () => {
    if (!containerRef.value) return

    const container = containerRef.value
    camera.aspect = container.clientWidth / container.clientHeight
    camera.updateProjectionMatrix()
    renderer.setSize(container.clientWidth, container.clientHeight)
  }

  window.addEventListener('resize', handleResize)

  // 监听容器大小变化
  const resizeObserver = new ResizeObserver(handleResize)
  resizeObserver.observe(containerRef.value!)

  // 监听屏幕方向变化
  window.addEventListener('orientationchange', () => {
    setTimeout(handleResize, 100) // 延迟处理，确保新尺寸生效
  })
}



// 颜色映射表
const colorMapping: Record<string, { name: string, color: string }> = {
  // A区域颜色
  'A1.png': { name: '深棕', color: '#8B4513' },
  'A2.png': { name: '玫瑰红', color: '#DC143C' },
  'A3.png': { name: '薄荷绿', color: '#98FB98' },
  'A4.png': { name: '纯白', color: '#FFFFFF' },
  'A5.png': { name: '帝王棕', color: '#8B7355' },
  'A6.png': { name: '琥珀棕', color: '#D2691E' },

  // B区域颜色
  'B1.png': { name: '百里茶', color: '#8B7D6B' },
  'B2.png': { name: '栗紫', color: '#722F37' },
  'B3.png': { name: '红褐', color: '#A0522D' },
  'B4.png': { name: '柳绿', color: '#9ACD32' },
  'B5.png': { name: '奶白', color: '#FDF5E6' },
  'B6.png': { name: '常春', color: '#D2B48C' }
}

// 获取颜色名称
const getColorName = (folder: 'A' | 'B', textureName: string) => {
  const mapping = colorMapping[textureName]
  return mapping ? mapping.name : textureName.replace('.png', '')
}

// 英文名映射（展示用）
const colorEnMapping: Record<string, string> = {
  // A
  'A1.png': 'Sparrow Brew',
  'A2.png': 'Sakura Drift',
  'A3.png': 'Willow Mist',
  'A4.png': 'Luminous Ripple',
  'A5.png': 'Imperial Infusion',
  'A6.png': 'Eternal Sandalwood',
  // B
  'B1.png': 'Gilded Void',
  'B2.png': 'Dewbound Violet',
  'B3.png': 'Dawn Althea',
  'B4.png': 'Willow Wash',
  'B5.png': 'Amber Nomad',
  'B6.png': 'Perpetual Verdure'
}

const getColorEn = (folder: 'A' | 'B', textureName: string) => {
  return colorEnMapping[textureName] || textureName.replace('.png', '')
}

// 获取颜色
const getColorForTexture = (folder: 'A' | 'B', textureName: string) => {
  const mapping = colorMapping[textureName]
  return mapping ? mapping.color : '#CCCCCC'
}

// 定制完成
const completeCustomization = () => {
  alert('定制完成！')
  // 可以选择保存当前的鞋子模型或贴图设置
  // 例如，将当前的贴图应用到实际的鞋子模型
  // 或者将当前的贴图保存为新的模型
  console.log('当前选中的A贴图:', selectedATexture.value)
  console.log('当前选中的B贴图:', selectedBTexture.value)
  console.log('当前相机位置:', cameraPosition.value)
  console.log('当前灯光强度:', lightingIntensity.value)
  console.log('当前动画状态:', isAnimating.value)

}

const onConfirm = () => {
  showConfirm.value = false
  completeCustomization()
}

const onCancel = () => {
  showConfirm.value = false
}



// 生命周期
onMounted(async () => {
  await nextTick()
  initThree()

    // 将Mesh操作函数添加到全局，方便控制台调用
    ; (window as any).getMeshByIndex = getMeshByIndex
    ; (window as any).getMeshByName = getMeshByName
    ; (window as any).meshList = meshList
    ; (window as any).switchToATexture = switchToATexture
    ; (window as any).switchToBTexture = switchToBTexture
    ; (window as any).getColorName = getColorName
    ; (window as any).getColorForTexture = getColorForTexture
    ; (window as any).completeCustomization = completeCustomization

})

onUnmounted(() => {
  if (animationId) {
    cancelAnimationFrame(animationId)
  }
  if (renderer) {
    renderer.dispose()
  }
  if (controls) {
    controls.dispose()
  }

})
</script>

<style>
/* 控制面板滚动条样式 */
.control-panel::-webkit-scrollbar {
  width: 6px;
}

.control-panel::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.control-panel::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
  transition: background 0.2s;
}

.control-panel::-webkit-scrollbar-thumb:hover {
  background: #a1a1a1;
}

/* 滑块样式 */
.slider::-webkit-slider-thumb {
  appearance: none;
  height: 16px;
  width: 16px;
  border-radius: 50%;
  background: #3498db;
  cursor: pointer;
  box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
}

.slider::-moz-range-thumb {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #3498db;
  cursor: pointer;
  border: none;
  box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
}

.slider::-webkit-slider-track {
  width: 100%;
  height: 8px;
  cursor: pointer;
  background: #ddd;
  border-radius: 4px;
}

.slider::-moz-range-track {
  width: 100%;
  height: 8px;
  cursor: pointer;
  background: #ddd;
  border-radius: 4px;
  border: none;
}

/* 移动端适配 */
@media (max-width: 768px) {

  /* 确保3D视窗在移动端有合适的高度 */
  .relative>div[ref="containerRef"] {
    height: calc(100vh - 300px) !important;
    min-height: 300px !important;
  }

  /* 底部面板在移动端的样式调整 */
  .absolute.bottom-0 {
    max-height: 60vh !important;
    overflow-y: auto !important;
  }

  /* 颜色选择器在移动端稍小一些 */
  .w-12.h-12 {
    width: 2.5rem !important;
    height: 2.5rem !important;
  }

  /* 调整颜色选择器间距 */
  .space-x-4>*+* {
    margin-left: 0.75rem !important;
  }

  /* 调整按钮高度 */
  .py-4 {
    padding-top: 0.75rem !important;
    padding-bottom: 0.75rem !important;
  }
}

/* 小屏幕适配 */
@media (max-width: 480px) {

  /* 进一步减小3D视窗高度 */
  .relative>div[ref="containerRef"] {
    height: calc(100vh - 350px) !important;
    min-height: 250px !important;
  }

  /* 颜色选择器更小 */
  .w-12.h-12 {
    width: 2rem !important;
    height: 2rem !important;
  }

  /* 减小间距 */
  .space-x-4>*+* {
    margin-left: 0.5rem !important;
  }

  .space-y-6>*+* {
    margin-top: 1rem !important;
  }

  /* 调整内边距 */
  .p-6 {
    padding: 1rem !important;
  }

  /* 调整字体大小 */
  .text-lg {
    font-size: 1rem !important;
  }

  /* 调整按钮文字大小 */
  .text-lg.font-semibold {
    font-size: 1rem !important;
  }
}

/* 横屏适配 */
@media (orientation: landscape) and (max-height: 600px) {
  .relative>div[ref="containerRef"] {
    height: 50vh !important;
    min-height: 200px !important;
  }

  .absolute.bottom-0 {
    max-height: 45vh !important;
  }
}

/* 触摸设备优化 */
@media (hover: none) and (pointer: coarse) {

  /* 触摸设备上的按钮反馈 */
  .cursor-pointer:active {
    transform: scale(0.95) !important;
    transition: transform 0.1s !important;
  }

  /* 颜色选择器的触摸反馈 */
  .w-12.h-12:active {
    transform: scale(0.9) !important;
  }

  /* 移除hover效果 */
  .hover\:border-gray-400:hover {
    border-color: inherit !important;
  }

  .hover\:from-orange-500:hover {
    background-image: inherit !important;
  }
}

/* 确保滚动条样式 */
.overflow-y-auto::-webkit-scrollbar {
  width: 4px;
}

.overflow-y-auto::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 2px;
}

.overflow-y-auto::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 2px;
}

.overflow-y-auto::-webkit-scrollbar-thumb:hover {
  background: #a1a1a1;
}

/* 确保白色颜色有边框可见性 */
.w-12.h-12[style*="background-color: rgb(255, 255, 255)"],
.w-12.h-12[style*="background-color: #FFFFFF"],
.w-12.h-12[style*="background-color: #FDF5E6"] {
  border: 4px solid #e5e5e5 !important;
}

/* 无障碍适配 */
@media (prefers-reduced-motion: reduce) {
  .animate-spin {
    animation: none !important;
  }

  .transition-all {
    transition: none !important;
  }

  .transform {
    transform: none !important;
  }
}

/* 高对比度模式支持 */
@media (prefers-contrast: high) {
  .bg-gradient-to-b {
    background: #f5f5f5 !important;
  }

  .text-gray-600 {
    color: #000000 !important;
  }

  .border-gray-300 {
    border-color: #000000 !important;
  }
}
</style>